<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Panel â€¢ Game List Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1020; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
  --blue:#2563eb; --blue2:#1d4ed8; --green:#10b981; --red:#ef4444; --amber:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#111827 0%,#0b1020 50%,#060914 100%);
  color:var(--text);font-family:Poppins,system-ui,Segoe UI,Arial,sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px}
h1{margin:0;font-size:20px;color:#bfdbfe}
.badge{background:#0b1225;border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;color:#dbeafe}
.container{max-width:1100px;margin:0 auto;padding:0 18px 40px}
.card{background:rgba(15,23,42,.75);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media (max-width:900px){.controls{grid-template-columns:1fr}}
.controls .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
button,.btn{background:linear-gradient(135deg,var(--blue),#9147ff);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:.2s}
button.secondary{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18)}
button.warning{background:linear-gradient(135deg,var(--amber),#ff8a00)}
button.danger{background:linear-gradient(135deg,var(--red),#ff4d4f)}
button:disabled{opacity:.5;cursor:not-allowed}
input[type="text"],input[type="url"],input[type="number"]{
  background:#0b1225;border:1px solid rgba(255,255,255,.14);color:#e2e8f0;border-radius:10px;padding:10px 12px;outline:none;min-width:180px}
input::placeholder{color:#94a3b8}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table thead th{color:#93c5fd;font-weight:700;text-align:left;padding:6px 8px}
.table tbody tr{background:#0b1225;border:1px solid rgba(255,255,255,.08)}
.table tbody tr td{padding:8px}
.table tbody tr td input{width:100%}
.tag{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;color:#cbd5e1}
.count{color:#a5b4fc;font-weight:700}
hr{border:none;border-top:1px dashed rgba(255,255,255,.18);margin:12px 0}
footer{opacity:.7;text-align:center;margin-top:16px;color:#cbd5e1}
.small{font-size:12px;color:#94a3b8}
.err{color:#fecaca}
.ok{color:#bbf7d0}
.warn{color:#fde68a}
a.test{color:#60a5fa}
.kbd{font-size:12px;background:#111827;border:1px solid rgba(255,255,255,.14);padding:2px 6px;border-radius:6px}
</style>
</head>
<body>

<header>
  <h1>ğŸ§° Admin Panel â€¢ Game List</h1>
  <div class="badge">Local JSON Editor (GitHub Pages uyumlu)</div>
</header>

<div class="container">
  <div class="card">
    <div class="controls">
      <div class="row">
        <button id="btnLoadFile" class="secondary">ğŸ“ list.json YÃ¼kle</button>
        <input id="fileInput" type="file" accept=".json" hidden>
        <input id="urlInput" type="url" placeholder="https://.../games/list.json (opsiyonel URL)">
        <button id="btnFetchUrl" class="secondary">ğŸŒ URL'den YÃ¼kle</button>
        <span id="status" class="small">HazÄ±r</span>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="btnUndo" class="secondary" disabled>â†¶ Geri Al</button>
        <button id="btnRedo" class="secondary" disabled>â†· Yeniden Yap</button>
        <button id="btnAdd">â• Yeni Oyun</button>
        <button id="btnExport" class="warning" disabled>ğŸ’¾ JSON'u DÄ±ÅŸa Aktar</button>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <input id="searchInput" type="text" placeholder="Ara: name / path / tags">
        <button id="btnSortAZ" class="secondary">Aâ†’Z SÄ±rala</button>
        <button id="btnSortZA" class="secondary">Zâ†’A SÄ±rala</button>
        <span class="tag">Toplam: <span id="count" class="count">0</span></span>
      </div>
      <div class="row" style="justify-content:flex-end">
        <span class="small">KÄ±sayollar: <span class="kbd">Ctrl+Z</span>, <span class="kbd">Ctrl+Y</span>, <span class="kbd">Ctrl+S</span></span>
      </div>
    </div>

    <hr>

    <table class="table">
      <thead>
        <tr>
          <th style="width:24%">Ad (name)</th>
          <th style="width:28%">Yol (path)</th>
          <th style="width:8%">Emoji</th>
          <th style="width:8%">Ãœnite</th>
          <th style="width:8%">Seviye</th>
          <th style="width:12%">Etiketler</th>
          <th style="width:12%">Ä°ÅŸlem</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <!-- rows -->
      </tbody>
    </table>

    <div id="validation" class="small" style="margin-top:10px;"></div>
  </div>

  <footer class="small">
    Bu panel yalnÄ±zca yerelde JSON Ã¼retir. DeÄŸiÅŸiklikler GitHubâ€™a otomatik gitmez â€” indirdiÄŸin <b>list.json</b> dosyasÄ±nÄ± <i>games/list.json</i> olarak repo'ya yÃ¼kle.
  </footer>
</div>

<script>
/* ===========================
   Basit parola korumasÄ±
   =========================== */
const ADMIN_KEY = "teacher2025"; // â† BURAYI deÄŸiÅŸtir!
(function gate(){
  const k = sessionStorage.getItem("admin_ok") || "";
  if (k === "1") return;
  const input = prompt("Admin anahtarÄ± (parola):");
  if (input !== ADMIN_KEY) {
    alert("YanlÄ±ÅŸ parola. EriÅŸim engellendi.");
    document.body.innerHTML = "<div style='color:#e11d48;padding:20px;font:16px/1.5 Poppins;'>EriÅŸim yok.</div>";
  } else {
    sessionStorage.setItem("admin_ok","1");
  }
})();

/* ===========================
   State ve yardÄ±mcÄ±lar
   =========================== */
let data = [];              // satÄ±rlar {name,path,emoji,unit,level,tags,desc,order}
let filtered = [];          // aramaya gÃ¶re
let historyStack = [];      // undo
let futureStack = [];       // redo
let dirty = false;

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const statusEl = $("#status");
const tbody = $("#tbody");
const countEl = $("#count");
const validationEl = $("#validation");

function setStatus(msg, cls="") {
  statusEl.textContent = msg;
  statusEl.className = "small " + cls;
}
function snapshot() {
  historyStack.push(JSON.stringify(data));
  if (historyStack.length>100) historyStack.shift();
  futureStack = [];
  updateUndoRedoButtons();
}
function updateUndoRedoButtons() {
  $("#btnUndo").disabled = historyStack.length===0;
  $("#btnRedo").disabled = futureStack.length===0;
}
function undo() {
  if (historyStack.length===0) return;
  futureStack.push(JSON.stringify(data));
  const prev = historyStack.pop();
  data = JSON.parse(prev);
  render();
  updateUndoRedoButtons();
}
function redo() {
  if (futureStack.length===0) return;
  historyStack.push(JSON.stringify(data));
  const next = futureStack.pop();
  data = JSON.parse(next);
  render();
  updateUndoRedoButtons();
}
function markDirty(v=true){
  dirty = v;
  $("#btnExport").disabled = !dirty || data.length===0;
}

/* ===========================
   YÃ¼kleme (dosya ve URL)
   =========================== */
$("#btnLoadFile").addEventListener("click", ()=> $("#fileInput").click());
$("#fileInput").addEventListener("change", ev=>{
  const f = ev.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const obj = JSON.parse(String(e.target.result));
      applyLoaded(obj);
      setStatus("Dosyadan yÃ¼klendi âœ…","ok");
    }catch(err){
      console.error(err);
      setStatus("JSON hatalÄ± (dosya) âŒ","err");
    }
  };
  reader.readAsText(f, "utf-8");
});

$("#btnFetchUrl").addEventListener("click", async ()=>{
  const url = $("#urlInput").value.trim();
  if(!url){ setStatus("URL boÅŸ","warn"); return; }
  try{
    setStatus("YÃ¼kleniyorâ€¦");
    const res = await fetch(url+"?t="+Date.now());
    if(!res.ok) throw new Error("HTTP "+res.status);
    const obj = await res.json();
    applyLoaded(obj);
    setStatus("URL'den yÃ¼klendi âœ…","ok");
  }catch(err){
    console.error(err);
    setStatus("URL yÃ¼klenemedi âŒ","err");
  }
});

function applyLoaded(obj){
  if(!Array.isArray(obj)) throw new Error("Liste bekleniyordu");
  // bilinmeyen alanlar da korunur
  data = obj.map(x=>({
    name: x.name ?? "",
    path: x.path ?? "",
    emoji: x.emoji ?? "ğŸ®",
    unit: x.unit ?? "",
    level: x.level ?? "",
    tags: Array.isArray(x.tags) ? x.tags : (x.tags ? String(x.tags) : ""),
    desc: x.desc ?? "",
    order: (typeof x.order==="number") ? x.order : ""
  }));
  historyStack = []; futureStack = [];
  markDirty(false);
  render();
}

/* ===========================
   Arama ve sÄ±ralama
   =========================== */
$("#searchInput").addEventListener("input", render);
$("#btnSortAZ").addEventListener("click", ()=>{
  if(data.length===0) return;
  snapshot();
  data.sort((a,b)=> String(a.name).localeCompare(String(b.name),'tr'));
  markDirty(true); render();
});
$("#btnSortZA").addEventListener("click", ()=>{
  if(data.length===0) return;
  snapshot();
  data.sort((a,b)=> String(b.name).localeCompare(String(a.name),'tr'));
  markDirty(true); render();
});

/* ===========================
   Tablo render ve satÄ±r iÅŸlemleri
   =========================== */
function render(){
  const q = $("#searchInput").value.trim().toLowerCase();
  filtered = !q ? data : data.filter(x=>{
    const hay = (x.name||"") + " " + (x.path||"") + " " + (Array.isArray(x.tags)?x.tags.join(","):x.tags||"");
    return hay.toLowerCase().includes(q);
  });
  tbody.innerHTML = "";
  filtered.forEach((row, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input data-k="name" value="${esc(row.name)}" placeholder="Milyoner 9.1"></td>
      <td><input data-k="path" value="${esc(row.path)}" placeholder="games/Milyoner9_1/"></td>
      <td><input data-k="emoji" value="${esc(row.emoji||'ğŸ®')}" placeholder="ğŸ®" style="max-width:80px;"></td>
      <td><input data-k="unit" value="${esc(row.unit||'')}" placeholder="9.1" style="max-width:80px;"></td>
      <td><input data-k="level" value="${esc(row.level||'')}" placeholder="A2/B1" style="max-width:90px;"></td>
      <td><input data-k="tags" value="${esc(Array.isArray(row.tags)?row.tags.join(', '):row.tags||'')}" placeholder="vocabulary, quiz"></td>
      <td>
        <button class="secondary testBtn">ğŸ”— Test</button>
        <button class="secondary upBtn">â¬†</button>
        <button class="secondary downBtn">â¬‡</button>
        <button class="danger delBtn">ğŸ—‘ï¸ Sil</button>
      </td>
    `;
    // input deÄŸiÅŸimleri
    tr.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        snapshotOnFirstEdit();
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==="tags"){
          // virgÃ¼lle dizi olarak sakla (boÅŸ ise string olarak boÅŸ kalsÄ±n)
          v = v.trim();
          row[k] = v ? v.split(",").map(s=>s.trim()).filter(Boolean) : "";
        } else {
          row[k] = v;
        }
        markDirty(true);
        validateAndShow();
      });
    });
    // test
    tr.querySelector(".testBtn").addEventListener("click", ()=>{
      const base = location.origin + location.pathname.replace(/\/admin\.html.*$/,'/');
      const url = (row.path||"").startsWith("http") ? row.path : (base + (row.path||""));
      window.open(url, "_blank");
    });
    // move up/down (sadece gÃ¶rÃ¼nÃ¼rde deÄŸil gerÃ§ek dizide)
    tr.querySelector(".upBtn").addEventListener("click", ()=>{
      const i = data.indexOf(row);
      if(i>0){ snapshot(); [data[i-1],data[i]] = [data[i],data[i-1]]; markDirty(true); render(); }
    });
    tr.querySelector(".downBtn").addEventListener("click", ()=>{
      const i = data.indexOf(row);
      if(i<data.length-1){ snapshot(); [data[i+1],data[i]] = [data[i],data[i+1]]; markDirty(true); render(); }
    });
    // del
    tr.querySelector(".delBtn").addEventListener("click", ()=>{
      if(!confirm(`"${row.name||row.path}" silinsin mi?`)) return;
      snapshot();
      data.splice(data.indexOf(row),1);
      markDirty(true);
      render();
      validateAndShow();
    });

    tbody.appendChild(tr);
  });
  countEl.textContent = String(filtered.length)+" / "+String(data.length);
  validateAndShow();
}

let firstEditTaken = false;
function snapshotOnFirstEdit(){
  if(!firstEditTaken){ snapshot(); firstEditTaken=true; }
}

/* ===========================
   Ekle / Export / Backup
   =========================== */
$("#btnAdd").addEventListener("click", ()=>{
  snapshot();
  data.push({
    name:"Yeni Oyun", path:"games/FolderName/", emoji:"ğŸ®",
    unit:"", level:"", tags:"", desc:"", order:""
  });
  markDirty(true);
  render();
  setStatus("Yeni satÄ±r eklendi","ok");
});

$("#btnExport").addEventListener("click", ()=>{
  // doÄŸrula (kritik hatalar varsa export engellenebilir)
  const errs = validate();
  if(errs.some(e=>e.level==="error")){
    if(!confirm("BazÄ± hatalar var. Yine de dÄ±ÅŸa aktarÄ±lsÄ±n mÄ±?")) return;
  }
  // backup
  const backupName = "list_backup_"+new Date().toISOString().replace(/[:.]/g,'-')+".json";
  downloadJSON(backupName, data);

  // asÄ±l dosya
  downloadJSON("list.json", data);
  markDirty(false);
  setStatus("JSON indirildi (yedek + asÄ±l) âœ…","ok");
});

function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

/* ===========================
   DoÄŸrulama
   =========================== */
function validate(){
  const errs = [];
  const paths = new Map();
  data.forEach((r, i)=>{
    if(!r.name || !r.name.trim()){
      errs.push({level:"error", msg:`#${i+1} name boÅŸ olamaz`});
    }
    if(!r.path || !r.path.trim()){
      errs.push({level:"error", msg:`#${i+1} path boÅŸ olamaz`});
    } else {
      const p = r.path.trim();
      if(!p.endsWith("/")){
        errs.push({level:"warn", msg:`#${i+1} path sonda "/" iÃ§ermeli (Ã¶rn. games/Milyoner9_1/)`});
      }
      const key = p.toLowerCase();
      paths.set(key, (paths.get(key)||0)+1);
    }
    // emoji boÅŸsa varsayÄ±lan
    if(!r.emoji){ r.emoji = "ğŸ®"; }
  });
  // tekrar path
  for(const [k, cnt] of paths.entries()){
    if(cnt>1) errs.push({level:"error", msg:`AynÄ± path birden fazla: "${k}"`});
  }
  return errs;
}
function validateAndShow(){
  const errs = validate();
  if(errs.length===0){
    validationEl.innerHTML = `<span class="ok">âœ” HiÃ§ hata yok.</span>`;
  } else {
    validationEl.innerHTML = errs.map(e=>{
      const cls = e.level==="error" ? "err" : "warn";
      return `<div class="${cls}">â€¢ ${escapeHTML(e.msg)}</div>`;
    }).join("");
  }
}

/* ===========================
   KÄ±sayollar (Undo/Redo/Save)
   =========================== */
document.addEventListener("keydown", (ev)=>{
  if(ev.ctrlKey && ev.key.toLowerCase()==="z"){ ev.preventDefault(); undo(); }
  if(ev.ctrlKey && ev.key.toLowerCase()==="y"){ ev.preventDefault(); redo(); }
  if(ev.ctrlKey && ev.key.toLowerCase()==="s"){ ev.preventDefault(); $("#btnExport").click(); }
});
$("#btnUndo").addEventListener("click", undo);
$("#btnRedo").addEventListener("click", redo);

/* ===========================
   Utils
   =========================== */
function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
function escapeHTML(s){ return esc(s); }

/* ===========================
   BaÅŸlangÄ±Ã§ durumu
   =========================== */
setStatus("HazÄ±r");
updateUndoRedoButtons();
render();
</script>
</body>
</html>
